deploy:
  needs: build
  runs-on: ubuntu-latest
  steps:
    # Step 1: Checkout the latest code
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Install lftp
    - name: Install lftp
      run: |
        echo "Installing lftp..."
        sudo apt-get update
        sudo apt-get install -y lftp

    # Step 3: Clear remote server directory
    - name: Clear remote server directory
      run: |
        echo "Connecting to FTP and deleting all remote files..."
        lftp -u "${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }}" ftp.trimworldwide.com << EOF
        set ssl:verify-certificate no
        cd /home/trimworldwide/rauf.trimworldwide.com
        mrm -rf *
        bye
        EOF

    # Step 4: Create additional files locally
    - name: Create .htaccess file
      run: |
        echo "Creating .htaccess file..."
        echo "${{ secrets.HTACCESS_CONTENT }}" > .htaccess

    - name: Create .env file
      run: |
        echo "Creating .env file..."
        echo "${{ secrets.ENV }}" > .env

    - name: Create config folder and file
      run: |
        echo "Creating config folder and file..."
        mkdir -p config
        echo "${{ secrets.CONFIG_DB }}" > config/config.js

    # Step 5: Verify created files
    - name: Verify created files
      run: ls -la

    # Step 6: Sync new files to the remote server
    - name: Sync files to remote server
      uses: SamKirkland/FTP-Deploy-Action@v4.2.0
      with:
        server: ftp.trimworldwide.com
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}

    # Step 7: Trigger npm install on the server
    - name: Trigger npm install on server
      run: |
        echo "Triggering npm install via PHP script..."
        curl -X GET "https://rauf.trimworldwide.com/trigger.php"
